---
title: "cfp model in package 'otos'"
author: "jean-mathieu vermosen"
date: "4/26/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
Sys.setenv(RETICULATE_PYTHON = '/opt/miniconda/envs/py38/bin/python')
knitr::opts_chunk$set(echo = TRUE)

library(reticulate)

# a function to grab the html docs produced by plotly
view <- function(path) {
  o   <- getOption("viewer")            # get viewer object
  uid <- system("uuid",intern=T)        # get uuid from system (requires uuid tool)
  tmp <- file.path(tempdir(), paste0(uid, '.html'))
  file.copy(path, tmp)                  # need to copy to temp file
  o(tmp)
}

```

## the Chen Feng Palomar model 

This document presents the model exposed in Chen, Feng, Palomar, Forecasting Intraday Trading Volume, A Kalman Filter Approach.

```{python}
import sys
sys.path.append('/home/vermosen/git/cfp/lib/Release/python')

from cfp import *
import numpy as np
```

the Chen, Feng, Palomar model (CFP) is specified by the following system:

$$
\begin{aligned}
y_t &= x_t \cdot c + \epsilon_t \\
x_{t+1} &= A_tx_t + \gamma_t
\end{aligned}
$$

with $\epsilon_t\sim \mathcal N(0, r)$ and $\gamma_t\sim\mathcal N(0, Q_t)$. Furthermore, the matrix $A_t$ is such that:

$$
\begin{aligned}
A_t=\left[
\begin{array}{cc}
\eta_t& 0\\
0 & \nu_t
\end{array}
\right]
\end{aligned}
$$

Let's generate a process according to some true parameters $\hat\theta$. The number of intraday periods is given by the length of the $\psi$ parameters

```{python}
real = cfp.parameters()

real.a_eta = 0.93970117964
real.a_mu  = 0.617656427391
real.s_eta = 0.00611157182105
real.s_mu  = 0.100157446738
real.r     = 0.0670554645138
real.pi    = [-0.0377453676475, 0.637412180444]
real.sigma = [9.49012643982e-05, 0.00182247858807]
real.psi   = [15.3322974898, 14.8914481022, 14.8960953411
         , 14.7328251327, 14.717101214 , 14.600429107 , 14.5878141379
         , 14.51710026  , 14.4863107795, 14.381950856 , 14.3423713871
         , 14.2429064605, 14.2109154215, 14.1635064751, 14.2339929961
         , 14.1522787054, 14.1947867672, 14.1869497863, 14.4385168913
         , 14.3792550185, 14.4077635371, 14.4649051166, 14.624926768
         , 14.7170306255, 15.0749366985, 15.9959231225]
         
n = len(real.psi)
```

We can generate simulations in the following way

```{python}
sd = -1 # will generate a random seed
sim = cfp.simulate(real, size=5000, seed=sd)
```

# Let's now assume the process is generated by some arbitrary parameter $\theta$ different from the true value $\hat\theta$. One can compute the corresponding kalman filter/smoother in the following way:

```{python}

p = cfp.parameters()
p.a_mu  = 0.5
p.s_eta = 0.5
p.s_mu  = 0.1
p.r     = 0.1
p.pi    = [0.1, 0.1]
p.sigma = [0.1, 0.1]
p.psi = [15] * n

md = cfp.model(p)
flt  = md.filter(sim)
smt  = md.smoother(sim)
pred = md.predict(sim, horizon=10)

# now we can compare the data with the filtered/smoothed series
import plotly as pl
import plotly.graph_objs as go
from plotly.subplots import make_subplots

# plot
fig = make_subplots(rows=1, cols=1)

fig = fig.add_trace(go.Scatter(y=sim, name='data'), row = 1, col = 1)
fig = fig.add_trace(go.Scatter(y=flt, name='filter'), row = 1, col = 1)
fig = fig.add_trace(go.Scatter(y=smt, name='smoother'), row = 1, col = 1)
#fig = fig.add_trace(go.Scatter(y=pred, name='prediction'), row = 1, col = 1)

fig = fig.update_layout(title_text="Generated data, Kalman filter and Smoother with startup parameter")

pl.io.write_html(fig, file='/tmp/data.html', auto_open=False)
```

```{r echo=FALSE}
view('/tmp/data.html')
```

The next step is to apply the em algorithm

```{python}
model = cfp.model(p)
fit = model.emax(sim, 10000, 1.0e-8)
```

then we simply update the plots with the fitted values

```{python}
md = cfp.model(fit)
flt  = md.filter(sim)
smt  = md.smoother(sim)

hrz = 10 # prediction horizon (2:30)
pred = md.predict(sim, horizon=hrz)
pred_lag = np.concatenate([np.nan * np.ones(hrz), pred])

# plot
fig = make_subplots(rows=1, cols=1)

fig = fig.add_trace(go.Scatter(y=sim, name='data'), row = 1, col = 1)
fig = fig.add_trace(go.Scatter(y=flt, name='filter'), row = 1, col = 1)
fig = fig.add_trace(go.Scatter(y=smt, name='smoother'), row = 1, col = 1)
fig = fig.add_trace(go.Scatter(y=pred_lag, name='prediction'), row = 1, col = 1)

fig = fig.update_layout(title_text="Generated data, Kalman filter and Smoother with fitted parameters")

pl.io.write_html(fig, file='/tmp/fit.html', auto_open=False)
```

```{r echo=FALSE}
view('/tmp/fit.html')
```

we compare the fitted parameters to the true values, in particular the resulting intraday profiles

```{python}
fig = make_subplots(rows=1, cols=1)

fig = fig.add_trace(go.Scatter(y=real.psi, name='true profile'), row = 1, col = 1)
fig = fig.add_trace(go.Scatter(y=fit.psi, name='fitted profile'), row = 1, col = 1)

fig = fig.update_layout(title_text="Generated intraday profile vs. true value")

pl.io.write_html(fig, file='/tmp/profiles.html', auto_open=False)
```

```{r echo=FALSE}
view('/tmp/profiles.html')
```